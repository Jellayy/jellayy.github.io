---
title: "WIP: Traefik Reverse Proxy in Docker with TLS Certs"
header:
  image: /assets/images/2022-09-02-ultimate-truenas-guide/banner.png
toc: true
toc_sticky: true
categories:
  - Guides
tags:
  - Homelab
---

# Configuring Your Domain

## Cloudflare DNS

This setup will be based on using the Cloudflare API to manage DNS on your domain. We will be using DNS challenges to issue certs with LetsEncrypt.

### Import your domain as a Cloudflare site (Optional)

If you purchased your domain through cloudflare, feel free to skip this step. If you got your domain through another registrar, you can register your site through cloudflare using the steps below.

#### Change your DNS servers to Cloudflare's

If you haven't purchased your domain through Cloudflare, you can still continue with this guide by changing the DNS servers your domain uses over to Cloudflare's. Change your nameservers to: `connie.ns.cloudflare.com` and `cris.ns.cloudflare.com`

Here's an example using Hostinger's dashboard:

![Hostinger Example]({{ site.url }}{{ site.baseurl }}/assets/images/2022-09-25-traefik/nameservers.png)

#### Add your site to Cloudflare

After changing your DNS servers, you can add your site to Cloudflare under Websites>Add a Site. For our purposes, the free plan works fine.

### Create an API Key

Head over to the [Cloudflare API Tokens Page](https://dash.cloudflare.com/profile/api-tokens) and create a new API Token with `Zone.Zone` and `Zone.DNS` permissions on either just the sites you want or all of your sites.

![Cloudflare API Key]({{ site.url }}{{ site.baseurl }}/assets/images/2022-09-25-traefik/apikey.png)

# Deploying Traefik

## File Structure

Deploying Traefik isn't completely plug-and-play and needs some files to get started.

Wherever you wish to place your Traefik configuration files, create the following file structure. You'll need to create all files listed, traefik does not create them itself and will yell at you if you don't. Create `acme.json` as an empty file for traefik to fill, we will configure `traefik.yml` in the next step.

{% highlight bash %}
traefik
│   traefik.yml   
│
└───acme
│   │   acme.json
│   
└───dynamic
{% endhighlight %}

### traefik.yml

Below is an example basic configuration of `traefik.yml` that will serve our purposes for now:

{% highlight yaml %}
global:
  checkNewVersion: true
  sendAnonymousUsage: false  # true by default

# (Optional) Log information
log:
   level: INFO  # DEBUG, INFO, WARNING, ERROR, CRITICAL
   format: common  # common, json, logfmt
   filePath: /var/log/traefik/traefik.log

# (Optional) Enable API and Dashboard
api:
  dashboard: true  # true by default
  insecure: true  # Don't do this in production!

# Entry Points configuration
entryPoints:
  http:
    address: :80
  https:
    address: :443

# Configure your CertificateResolver here...
certificatesResolvers:
   letsEncrypt:
     acme:
       email: YOUR_EMAIL
       storage: /etc/traefik/acme/acme.json
       dnsChallenge:
         provider: cloudflare
         resolvers:
           - 1.1.1.1:53
           - 8.8.8.8:53
         delayBeforeCheck: 0

providers:
  docker:
    endpoint: unix:///var/run/docker.sock
    exposedByDefault: false  # Default is true
  file:
    # watch for dynamic configuration changes
    directory: /etc/traefik/dynamic
    watch: true
{% endhighlight %}

## Docker

### Proxy Network

Create a new attachable bridge network in Docker for Traefik to use. This can be done in the docker CLI or through a managment portal such as Portainer. We will attach our Traefik container and all other proxied containers to this network.

{% highlight bash %}
docker network create -d bridge --attachable proxy
{% endhighlight %}

![Portainer Network Create]({{ site.url }}{{ site.baseurl }}/assets/images/2022-09-25-traefik/portainer-network-create.png)

### Creating the Container

Deploy Traefik using Docker Compose:

{% highlight yaml %}
version: '3'

services:
  traefik:
    image: "traefik:v2.5"
    container_name: "traefik"
    environment:
      - CF_API_EMAIL=YOUR_EMAIL
      - CF_DNS_API_TOKEN=YOUR_API_KEY
      - CF_ZONE_API_TOKEN=YOUR_API_KEY
    networks:
      - proxy
    ports:
      - "80:80"
      - "443:443"
      # (Optional) Expose Dashboard
      - "42069:8080"  # Don't do this in production!
    volumes:
      - /config/docker/traefik-logs:/var/log/traefik
      - /config/docker/traefik:/etc/traefik
      - /var/run/docker.sock:/var/run/docker.sock:ro

networks:
  proxy:
    external: true
{% endhighlight %}

> Leaving your API keys exposed in docker-compose like this is not recommended. Environment variables in docker containers also aren't particularly secure. Running a secrets agent like the one built in to docker-swarm is recommended. Will I be covering that here? Absolutely not.

